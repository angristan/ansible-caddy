{{ ansible_managed | comment(decoration="# ") }}
{% if vhost.www_redir %}
www.{{ vhost.hostname }} {
    import ../snippets/tls.conf
    redir https://{{ vhost.hostname }}{uri}
}
{% endif %}
{{ vhost.hostname }} {
  import ../snippets/tls.conf
  {{ 'gzip' if vhost.gzip else '' }}
  log / {{ caddy_log_path }}/{{ vhost.hostname }}.log {combined}
  errors {{ caddy_log_path }}/{{ vhost.hostname }}_errors.log
  proxy / {{ vhost.proxy_host }}{{ ":" ~ vhost.proxy_port if vhost.proxy_port is defined else '' }} {
    {{ 'transparent' if vhost.proxy_transparent else '' }}
    {{ 'websocket' if vhost.proxy_websocket else '' }}
  }
{% if vhost.security_headers %}
  header / {
    Strict-Transport-Security "max-age=31536000;"
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
  }
{% endif -%}
{% if vhost.basicauth %}
  basicauth {{ vhost.basicauth_path }} {{ vhost.basicauth_user }} {{ vhost.basicauth_password }}
{% endif %}
{% if vhost.realip %}
  realip {
{% for realip in vhost.realip_from %}
    from {{ realip }}
{% endfor %}
  }
{% endif %}
}
